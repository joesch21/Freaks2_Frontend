<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="format-detection" content="telephone=no">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>Freaky Friday - GCC</title>

  <!-- Fonts & CSS -->
   <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Creepster&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./freakyfriday.css"/>

  <!-- Preload hero for faster LCP -->
  <link rel="preload" as="image" href="./freaks.jpg" />
</head>

<body>
  <!-- Spinner (optional, your existing JS toggles .hidden) -->
  <div id="loader" class="hidden"><div class="spinner"></div></div>

  <div class="mobile-open-bar">
    <button id="openInMMTop" class="deeplink-btn">Open in MetaMask (mobile)</button>
  </div>

  <!-- Mode Badge -->
  <div id="modeBadge" class="mode-badge">â€”</div>

  <!-- Admin Panel (hidden by default) -->
  <section id="adminPanel" class="admin-panel" style="display:none;">
    <h3>Admin Controls</h3>
    <div class="admin-actions">
      <button id="btnModeStandard" class="btn-admin">Switch to Standard</button>
      <button id="btnModeJackpot" class="btn-admin danger">Switch to Jackpot</button>
    </div>
    <div id="adminStatus" class="admin-status"></div>
  </section>

  <div id="roundState" class="round-state">â€”</div>

  <section id="adminArmPanel" class="admin-panel" style="display:none;">
    <h3>Admin Controls</h3>
    <div class="admin-actions">
      <button id="btnArmRound" class="btn-admin">Open New Round</button>
    </div>
    <div id="adminArmStatus" class="admin-status"></div>
  </section>

  <main class="stage">
    <!-- Big scary poster -->
    <figure class="poster" aria-hidden="true">
      <img id="freakyPoster" src="./freaks.jpg" alt="" />
      <div class="vignette"></div>

      <!-- eye overlay (two glints) -->
      <div class="eye-layer">
        <span class="glint"></span>
        <span class="halo"></span>
      </div>

      <figcaption class="sr-only">Freaky Friday â€” GCC ritual game</figcaption>
    </figure>

    <!-- Title floating over poster -->
    <header class="heroTitle">
      <h1 class="condor-title">ğŸ¦… Freaky Friday</h1>
      <p class="subtext">A Weekly Ritual for Brave GCC Holders</p>
    </header>

    <!-- Right dock controls -->
    <aside class="dock" role="region" aria-label="Join Freaky Friday">
      <div class="dock-inner actions">
        <button class="dock-handle" aria-expanded="true" aria-label="Toggle panel">
        <span class="grip">â‹®â‹®</span>
        <span class="label">Open in MetaMask (mobile)</span>
        <span class="chev">â–¾</span>
      </button>
        <p id="metamaskLink" class="hidden">
          <a id="deeplink" class="deeplink" href="https://metamask.app.link/dapp/freaks2-frontend.onrender.com">ğŸ“± Open in MetaMask (mobile)</a>
        </p>

        <button id="connectBtn">ğŸ”— Connect Wallet</button>
        <button id="approveBtn" disabled>âœ… Step 1: Approve 50Â GCC to Contract</button>
        <button id="joinBtn" class="btn-join" disabled>ğŸš€ Step 2: Join the Ritual</button>

        <div id="status" class="status" role="status">â³ Waiting for wallet connection...</div>
        <p>Wallet: <span id="walletAddress">â€”</span></p>

        <div class="vault">
          <h3>ğŸ“Š Ritual Vault</h3>
          <p>GCC in contract: <span id="gccBalance">â€¦</span></p>
          <p>BNB in contract: <span id="bnbBalance">â€¦</span></p>

          <p>Mode: <span id="modeDisplay">â€¦</span></p>

          <!-- Player count row -->
          <div class="ff-stats">
            <span class="ff-pill"><strong id="ff-player-count">0</strong> players</span>
            <button id="ff-open-participants" class="ff-link" style="display:inline-block">View list</button>
          </div>

          <!-- Friendlier already-joined badge -->
          <span id="ff-joined-badge" class="ff-joined-badge" style="display:none">âœ… Already joined this round</span>

          <!-- Timer + progress bar -->
          <div id="timerContainer" class="ff-timer">
            <div class="ff-timer-row">
              <span id="ff-time-label">Round ends in:</span>
              <span id="countdown">00:00</span>
            </div>
            <div class="ff-progress">
              <div id="ff-progress-bar"></div>
            </div>
          </div>

          <p id="winnerContainer" style="display:none;">
            ğŸ”® Predicted Winner: <span id="predictedWinner">-</span>
          </p>

          <!-- Last winner display (updated dynamically via JS) -->
          <section class="last-winner" style="margin-top:12px;">
            <p id="lastWinnerRow" style="display:none;">
              ğŸ† Last winner (round <span id="lastWinnerRound">â€“</span>):
              <span id="lastWinnerAddr">â€“</span>
            </p>
          </section>
        </div>
      </div>
    </aside>

    <!-- optional: small invisible debug slot for contract/relayer -->
    <pre id="debug" style="display:none"></pre>

    <footer class="footer">
      <p class="footer-note flicker">Built by the Condor Crew. Powered by GCC. Fueled by ritual.</p>
    </footer>
  </main>

  <!-- Left off-canvas drawer -->
  <aside id="ff-drawer" class="ff-drawer" aria-hidden="true">
    <div class="ff-drawer-header">
      <h3>Participants</h3>
      <button id="ff-close-participants" class="ff-icon-btn" aria-label="Close">âœ–</button>
    </div>
    <ul id="participantList" class="ff-participants"><li>Loading...</li></ul>
    <div class="ff-drawer-footer">
      <button id="ff-refresh-participants" class="ff-btn-secondary">Refresh</button>
    </div>
  </aside>

  <!-- Dim overlay -->
  <div id="ff-drawer-overlay" class="ff-drawer-overlay" aria-hidden="true"></div>

  <div id="mmHintMount"></div>
  <button id="connectBtnLower" class="connect-sticky" aria-label="Connect Wallet (mobile)">
    ğŸ”— Connect Wallet
  </button>

  <button id="openLastRound" class="pill">Last Round</button>

  <aside id="lastRoundPanel" class="drawer right" style="display:none;">
    <header>
      <h3>Last Round</h3>
      <button class="drawer-close" aria-label="Close">Ã—</button>
    </header>
    <div class="drawer-body">
      <div>Last round: <span id="lr_round">â€”</span> â€¢ <span id="lr_mode">â€”</span></div>
      <div>Winner: <span id="lr_winner">â€”</span></div>
      <div>Prize: <span id="lr_prize">â€”</span></div>
      <div>Refund: <span id="lr_refund">â€”</span></div>
      <button id="lr_claim" class="primary" style="margin-top:.75rem; display:none;">ğŸ’¸ Claim refund</button>
      <p id="lr_hint" class="muted" style="display:none; margin-top:.25rem;">If you opened from Safari/Chrome, this page likely deeplinked into MetaMask. Tap the button again if asked.</p>
    </div>
  </aside>

  <script>
    document.getElementById('openLastRound')?.addEventListener('click', () =>
      document.getElementById('lastRoundPanel')?.classList.add('open'));
    document.querySelector('#lastRoundPanel .drawer-close')?.addEventListener('click', () =>
      document.getElementById('lastRoundPanel')?.classList.remove('open'));
  </script>

  <!-- Rules Tab Trigger -->
  <button id="rulesTab" aria-controls="rulesDrawer" aria-expanded="false">Rules</button>

  <!-- Backdrop -->
  <div id="rulesBackdrop" hidden></div>

  <!-- Slide-in Drawer -->
  <aside id="rulesDrawer" aria-hidden="true" role="dialog" aria-labelledby="rulesTitle">
    <header class="rules__header">
      <h2 id="rulesTitle">How Freaky Friday works</h2>
      <button id="rulesClose" aria-label="Close">âœ•</button>
    </header>
    <div class="rules__body">
      <h3>1. Modes</h3>
      <ul>
        <li>Standard Ritual: Each entry is 50 GCC. At round close the winner receives 1 GCC Ã— number of players. Every participant (including the winner) can claim a 49 GCC refund.</li>
        <li>Jackpot Ritual: Each entry is 50 GCC. At round close the winner receives all entries (no refunds).</li>
      </ul>
      <h3>2. Rounds</h3>
      <ul>
        <li>A round starts when the first player joins and runs for the configured duration shown by the timer.</li>
        <li>Anyone can call Close Round (our backend cron usually does it). A small tip may be paid to the closer from surplus funds.</li>
      </ul>
      <h3>3. Refunds (Standard mode)</h3>
      <ul>
        <li>Your refund is available after the round is closed. Use Claim Refund on the page.</li>
        <li>Refunds do not expire but you must claim per round.</li>
      </ul>
      <h3>4. Transparency</h3>
      <ul>
        <li>Winner is selected with onâ€‘chain pseudoâ€‘randomness based on block data.</li>
        <li>Contract: 0x2a37F0325bcA2B71cF7f2189796Fb9BC1dEBc9C9</li>
      </ul>
      <h3>5. Fees & Tokens</h3>
      <ul>
        <li>Token: GCC (18 decimals). Network: BNB Smart Chain.</li>
      </ul>
    </div>
    <footer class="rules__footer">
      <a class="rules__link" href="https://bscscan.com/address/0x2a37F0325bcA2B71cF7f2189796Fb9BC1dEBc9C9" target="_blank" rel="noopener">View contract on BscScan</a>
    </footer>
  </aside>

  <!-- Ethers + your app -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.7.0/dist/ethers.umd.min.js"></script>
  <script type="importmap">
  {
    "imports": {
      "ethers": "https://cdn.jsdelivr.net/npm/ethers@6.7.0/dist/ethers.min.js"
    }
  }
  </script>
  <script type="module" src="./freakyfriday.js"></script>
  <script type="module" src="./participants-drawer.js"></script>
  <script type="module">
    import { initRoundTimer } from './round-timer.js';
    initRoundTimer('joinBtn');
  </script>

  <script type="module">
  import { gameRead } from './frontendcore.js';
  (async () => {
    try {
      const relayer = await gameRead.relayer?.();
      const entry   = await gameRead.entryAmount?.();
      const dbg = document.getElementById('debug');
      if (dbg) {
        dbg.textContent = `relayer=${relayer}\nentry=${entry ? ethers.formatUnits(entry,18) : 'n/a'}`;
      }
    } catch {}
  })();
  </script>

  <!-- Heatâ€‘warp SVG filter (hidden) -->
  <svg width="0" height="0" style="position:absolute">
    <filter id="condorWiggle">
      <feTurbulence type="fractalNoise" baseFrequency="0.003 0.006" numOctaves="2" seed="13" result="noise"/>
      <feDisplacementMap in="SourceGraphic" in2="noise" scale="6" xChannelSelector="R" yChannelSelector="G"/>
    </filter>
  </svg>

  <!-- Parallax + Eyeâ€‘glint + Heartbeat -->
  <script>
  (() => {
    const img = document.getElementById('freakyPoster');
    const eye = document.querySelector('.eye-layer');
    const stage = document.querySelector('.stage') || document.body;
    const countdownEl = document.getElementById('countdown');
    if (!img || !eye) return;

    const rMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    if (rMotion) return;

    // --- Parallax tilt + eye tracking ---
    let targetRx = 0, targetRy = 0, rafId = null;
    let currentRx = 0, currentRy = 0;
    const lerp = (a,b,t)=>a+(b-a)*t, clamp=(v,lo,hi)=>Math.max(lo,Math.min(hi,v));

    function updateEye(clientX, clientY) {
    const r = img.getBoundingClientRect();

    // Normalized pointer (0..1)
    const nx = clientX == null ? 0.5 : (clientX - r.left) / r.width;
    const ny = clientY == null ? 0.5 : (clientY - r.top) / r.height;

    // Read base from CSS (so you can tweak without code)
    const cs = getComputedStyle(eye);
    const baseX = (parseFloat(cs.getPropertyValue('--eye-base-x')) || 46) / 100;
    const baseY = (parseFloat(cs.getPropertyValue('--eye-base-y')) || 27) / 100;

    // Small responsive offset around the base (subtle tracking)
    const offsetX = (nx - 0.5) * 3.2;  // % of width
    const offsetY = (ny - 0.5) * 2.6;  // % of height

    eye.style.setProperty('--eye-left', `${(baseX*100) + offsetX}%`);
    eye.style.setProperty('--eye-top',  `${(baseY*100) + offsetY}%`);
  }


    function onPointer(e){
      const r = img.getBoundingClientRect();
      const x = (e.clientX - r.left) / r.width;
      const y = (e.clientY - r.top) / r.height;
      targetRy = clamp((x - 0.5) * 10, -6, 6);
      targetRx = clamp((0.5 - y) * 6, -4, 4);
      updateEye(e.clientX, e.clientY);
      startRAF();
    }

    function onOrient(e){
      const beta  = clamp(e.beta  || 0, -30, 30);
      const gamma = clamp(e.gamma || 0, -30, 30);
      targetRx = (beta / 30)  * 4;
      targetRy = (gamma / 30) * 6;
      updateEye();
      startRAF();
    }

    function startRAF(){ if (!rafId) rafId = requestAnimationFrame(loop); }
    function loop(){
      currentRx = lerp(currentRx, targetRx, 0.08);
      currentRy = lerp(currentRy, targetRy, 0.08);
      img.style.transform =
        `perspective(800px) rotateX(${currentRx}deg) rotateY(${currentRy}deg) scale(1.07)`;
      if (Math.abs(currentRx-targetRx)>0.01 || Math.abs(currentRy-targetRy)>0.01) {
        rafId = requestAnimationFrame(loop);
      } else { rafId = null; }
    }

    window.addEventListener('mousemove', onPointer, { passive:true });
    window.addEventListener('deviceorientation', onOrient, { passive:true });
    updateEye(); // initial glint

    // --- Heartbeat when countdown <= 60s ---
    function parseCountdown(el){
      if (!el) return null;
      const m = el.textContent.match(/(\d{1,2}):(\d{2})/);
      return m ? (+m[1])*60 + (+m[2]) : null;
    }
    function heartbeatCheck(){
      const secs = parseCountdown(countdownEl);
      if (secs == null) return;
      if (secs <= 60) stage.classList.add('heartbeat');
      else            stage.classList.remove('heartbeat');
    }
    setInterval(heartbeatCheck, 1000);
  })();
  </script>
  <script>
(() => {
  const dock = document.querySelector('.dock');
  const handle = document.querySelector('.dock-handle');
  if (!dock || !handle) return;

  const LS_POS = 'dockPos';
  const LS_COL = 'dockCollapsed';

  // --- Restore last state
  const savedPos = localStorage.getItem(LS_POS) || 'bottom';
  const savedCol = localStorage.getItem(LS_COL) === '1';
  dock.classList.add('pos-' + (savedPos === 'top' ? 'top' : 'bottom'));
  if (savedCol) { dock.classList.add('collapsed'); handle.setAttribute('aria-expanded', 'false'); }

  // --- Click to collapse / expand
  handle.addEventListener('click', () => {
    const isCollapsed = dock.classList.toggle('collapsed');
    handle.setAttribute('aria-expanded', String(!isCollapsed));
    localStorage.setItem(LS_COL, isCollapsed ? '1' : '0');
  });

  // --- Click bottom/top corners of the handle to snap position
  handle.addEventListener('dblclick', () => {
    const toTop = !dock.classList.contains('pos-top');
    dock.classList.toggle('pos-top', toTop);
    dock.classList.toggle('pos-bottom', !toTop);
    localStorage.setItem(LS_POS, toTop ? 'top' : 'bottom');
  });

  // --- Quick drag to snap (up = top, down = bottom)
  let startY = 0, dragging = false;
  const start = (y) => { startY = y; dragging = true; dock.classList.add('grabbing'); };
  const move  = (y) => {
    if (!dragging) return;
    const delta = y - startY;
    // Visual hint: translate a little while dragging
    dock.style.transform = `translateY(${Math.max(-40, Math.min(40, delta/3))}px)`;
  };
  const end = (y) => {
    if (!dragging) return;
    dock.classList.remove('grabbing'); dock.style.transform = '';
    const delta = y - startY;
    if (Math.abs(delta) > 40) {
      const toTop = delta < 0;
      dock.classList.toggle('pos-top', toTop);
      dock.classList.toggle('pos-bottom', !toTop);
      localStorage.setItem(LS_POS, toTop ? 'top' : 'bottom');
    }
    dragging = false;
  };

  // Mouse + touch
  handle.addEventListener('mousedown', e => start(e.clientY));
  window.addEventListener('mousemove', e => move(e.clientY));
  window.addEventListener('mouseup',   e => end(e.clientY));

  handle.addEventListener('touchstart', e => start(e.touches[0].clientY), { passive: true });
  window.addEventListener('touchmove',  e => move(e.touches[0].clientY),  { passive: true });
  window.addEventListener('touchend',   e => end((e.changedTouches[0]||{}).clientY), { passive: true });

  // --- Auto-hide on scroll down, show on scroll up
  let lastY = window.scrollY;
  dock.classList.add('autohide');
  window.addEventListener('scroll', () => {
    const y = window.scrollY;
    const down = y > lastY;
    dock.classList.toggle('hide', down && !dock.classList.contains('collapsed'));
    lastY = y;
  }, { passive: true });

})();
</script>

<script>
(() => {
  const tab = document.getElementById('rulesTab');
  const drawer = document.getElementById('rulesDrawer');
  const closeBtn = document.getElementById('rulesClose');
  const backdrop = document.getElementById('rulesBackdrop');

  function openDrawer(){
    drawer.classList.add('open');
    drawer.setAttribute('aria-hidden', 'false');
    tab.setAttribute('aria-expanded', 'true');
    backdrop.hidden = false;
    // avoid covering CTAs â€” scroll into view if overlap
    document.querySelector('#app')?.scrollIntoView({block:'start', behavior:'smooth'});
  }
  function closeDrawer(){
    drawer.classList.remove('open');
    drawer.setAttribute('aria-hidden', 'true');
    tab.setAttribute('aria-expanded', 'false');
    backdrop.hidden = true;
  }

  tab.addEventListener('click', openDrawer);
  closeBtn.addEventListener('click', closeDrawer);
  backdrop.addEventListener('click', closeDrawer);
  document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeDrawer(); });

  // optional: swipe-to-close on mobile
  let startY=null;
  drawer.addEventListener('touchstart', e => startY = e.touches[0].clientY, {passive:true});
  drawer.addEventListener('touchmove', e => {
    if(startY===null) return;
    const dy = e.touches[0].clientY - startY;
    if (dy > 60) closeDrawer();
  }, {passive:true});
})();
</script>
</body>
</html>
